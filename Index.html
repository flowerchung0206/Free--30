import React, { useState, useEffect } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment } from 'firebase/firestore';
import { MessageCircle, ChevronRight, CheckCircle2, Camera, Check, ExternalLink, Loader2, ShieldCheck } from 'lucide-react';

// --- 全域變數預設值 (避免讀不到環境變數而白畫面) ---
let auth = null;
let db = null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'qiaolai-luxury-2026';

// --- 極致安全初始化 ---
try {
  if (typeof __firebase_config !== 'undefined') {
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    auth = getAuth(app);
    db = getFirestore(app);
  }
} catch (e) {
  console.log("雲端模組初始化中...");
}

const App = () => {
  const [user, setUser] = useState(null);
  const [claimedCount, setClaimedCount] = useState(0);
  const [isClaiming, setIsClaiming] = useState(false);
  const [myTicket, setMyTicket] = useState(null);
  const [loading, setLoading] = useState(false); 
  const [clickCount, setClickCount] = useState(0); 
  const [showAdmin, setShowAdmin] = useState(false);

  const totalLimit = 30;
  const fbLink = "https://www.facebook.com/share/185pmSU5n5/";
  const lineId = "@840asvpf"; 

  // --- 登入邏輯 ---
  useEffect(() => {
    const initAuth = async () => {
      if (!auth) return;
      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.log("自動登入中...");
      }
    };
    initAuth();
    
    if (auth) {
      const unsub = onAuthStateChanged(auth, (u) => {
        if (u) setUser(u);
      });
      return () => unsub();
    }
  }, []);

  // --- 雲端數據監控 ---
  useEffect(() => {
    if (!user || !db) return;

    try {
      const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'counter');
      const unsubGlobal = onSnapshot(counterRef, (snap) => {
        if (snap.exists()) setClaimedCount(snap.data().count || 0);
      }, (err) => console.log("計數同步中..."));

      const userClaimRef = doc(db, 'artifacts', appId, 'users', user.uid, 'claims', 'ticket');
      const unsubUser = onSnapshot(userClaimRef, (snap) => {
        if (snap.exists()) setMyTicket(snap.data());
      }, (err) => console.log("領取紀錄讀取中..."));

      return () => { unsubGlobal(); unsubUser(); };
    } catch (e) {
      console.log("監控模式準備中...");
    }
  }, [user]);

  const handleClaim = async () => {
    if (isClaiming || myTicket || claimedCount >= totalLimit) return;
    setIsClaiming(true);
    
    const ticketId = `CHX-${Math.random().toString(36).substr(2, 5).toUpperCase()}-${Math.floor(Date.now()/1000).toString().slice(-4)}`;
    
    try {
      if (user && db) {
        const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'counter');
        const userClaimRef = doc(db, 'artifacts', appId, 'users', user.uid, 'claims', 'ticket');
        await setDoc(userClaimRef, { ticketId, claimedAt: new Date().toISOString(), userId: user.uid });
        await updateDoc(counterRef, { count: increment(1) });
      } else {
        setMyTicket({ ticketId });
        setClaimedCount(prev => prev + 1);
      }
    } catch (e) {
      setMyTicket({ ticketId });
      setClaimedCount(prev => prev + 1);
    } finally {
      setIsClaiming(false);
    }
  };

  const goToLine = () => {
    const message = `闆娘您好！我已領取蕎淶清飲回饋序號：【${myTicket.ticketId}】。\n\n我會立刻傳送「本頁序號截圖」及「臉書分享截圖」給您核對！`;
    window.location.href = `https://line.me/R/oaMessage/${lineId}/?${encodeURIComponent(message)}`;
  };

  return (
    <div className="min-h-screen bg-[#fcfaf7] text-[#333] font-sans pb-20">
      {/* Header - 活動名稱改為：回饋好禮 */}
      <header className="relative h-[220px] bg-[#6b1111] flex flex-col items-center justify-center overflow-hidden">
        <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/pinstriped-suit.png')]" />
        <div className="z-10 text-center px-6">
          <div className="inline-block border border-[#c9a063] px-6 py-1 mb-4">
            <p className="text-[#c9a063] text-[10px] tracking-[0.4em] uppercase font-bold">蕎淶清飲 2026</p>
          </div>
          <h1 className="text-5xl font-bold text-[#f2e6d0] mb-2 tracking-[0.1em]">回饋好禮</h1>
          <p className="text-[#f2e6d0] text-[10px] tracking-[0.5em] font-light opacity-80 uppercase italic">Luxury & Taste</p>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-md mx-auto px-5 -mt-8 relative z-20">
        <div className="bg-white shadow-2xl rounded-sm">
          <div className="p-8">
            <div className="flex justify-between items-end mb-8 border-b border-slate-100 pb-6">
              <div className="flex-1">
                <h2 className="text-lg font-bold text-[#1a1a1a] leading-tight">限量回饋原味鬆餅乙份</h2>
                <div className="flex items-center gap-1 mt-2">
                  <ShieldCheck size={12} className="text-[#c9a063]" />
                  <p className="text-[10px] text-[#c9a063] font-bold tracking-widest uppercase">每人限領乙份</p>
                </div>
              </div>
              <div className="text-right ml-4">
                <span className="text-[10px] text-slate-300 block font-bold uppercase tracking-widest mb-1">Remainings</span>
                <span className="text-4xl font-light text-[#6b1111]">
                  {Math.max(0, totalLimit - claimedCount)}
                  <span className="text-xs text-slate-300 font-normal ml-1">/ {totalLimit}</span>
                </span>
              </div>
            </div>

            {!myTicket ? (
              <div className="space-y-6">
                <div className="space-y-3">
                  <div className="flex items-center gap-2 text-[#6b1111] mb-1">
                    <CheckCircle2 size={16} />
                    <h3 className="text-[11px] font-bold tracking-widest uppercase">領取流程說明</h3>
                  </div>
                  <div className="p-4 border border-[#c9a063]/20 bg-[#fcfaf7] flex items-start gap-3 rounded-sm">
                    <div className="w-5 h-5 rounded-full bg-[#c9a063] flex items-center justify-center flex-shrink-0">
                      <Check size={12} className="text-white" />
                    </div>
                    <div className="flex-1">
                      <p className="text-xs font-bold text-black leading-relaxed">請確認已公開分享活動貼文</p>
                      <a href={fbLink} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-[10px] text-[#6b1111] font-bold mt-1 underline">
                        <ExternalLink size={10} /> 前往活動貼文頁面
                      </a>
                    </div>
                  </div>
                </div>

                {/* 按鈕文字改為：領取兌換序號 */}
                <button
                  onClick={handleClaim}
                  disabled={isClaiming || (claimedCount >= totalLimit)}
                  className="w-full py-5 bg-[#1a1a1a] text-[#c9a063] flex items-center justify-center gap-3 tracking-[0.3em] font-bold text-sm shadow-xl active:scale-95 transition-all"
                >
                  {isClaiming ? <Loader2 className="animate-spin" /> : (claimedCount >= totalLimit ? "已全數發完" : "領取兌換序號")}
                  {!isClaiming && claimedCount < totalLimit && <ChevronRight size={18} />}
                </button>
              </div>
            ) : (
              <div className="text-center py-2 animate-in fade-in zoom-in duration-500">
                <p className="text-[9px] text-slate-400 tracking-[0.3em] uppercase mb-3 font-bold">專屬回饋序號</p>
                <div className="text-3xl font-mono font-bold tracking-wider text-[#1a1a1a] border-y border-[#c9a063]/30 py-8 px-4 inline-block mb-8">
                  {myTicket.ticketId}
                </div>
                
                <div className="bg-[#fcfaf7] border border-[#f2e6d0] p-6 mb-8 text-left relative">
                  <div className="absolute -top-3 left-4 bg-[#6b1111] text-white px-3 py-1 text-[9px] font-bold tracking-widest uppercase flex items-center gap-1">
                    <Camera size={10} /> 請截圖保存
                  </div>
                  <p className="text-xs text-slate-600 leading-relaxed">
                    領取成功！請將<span className="text-black font-bold border-b-2 border-[#c9a063]">此頁序號截圖</span>，連同您的<span className="text-black font-bold border-b-2 border-[#c9a063]">臉書分享截圖</span>，傳送至官方 LINE <span className="text-[#6b1111] font-bold underline decoration-[#c9a063]">闆娘核對</span>！
                  </p>
                </div>

                <button
                  onClick={goToLine}
                  className="w-full bg-[#06C755] text-white py-5 flex items-center justify-center gap-3 font-bold shadow-lg hover:brightness-105 active:scale-95 transition-all rounded-sm"
                >
                  <MessageCircle size={22} fill="white" />
                  <span className="tracking-widest text-sm font-bold">傳送截圖至官方 LINE</span>
                </button>
              </div>
            )}
          </div>
        </div>

        <section className="mt-8 space-y-3">
          <div className="bg-white/60 p-4 border-l-4 border-[#c9a063] flex flex-col items-center text-center">
            <p className="text-[9px] text-slate-400 uppercase tracking-widest mb-1 font-bold">門市地址</p>
            <p className="text-[11px] text-slate-600 font-medium tracking-tight">桃園市桃園區文中二路25巷22號</p>
          </div>
          <div className="bg-white/60 p-4 border-l-4 border-[#6b1111] flex flex-col items-center text-center">
            <p className="text-[9px] text-slate-400 uppercase tracking-widest mb-1 font-bold">兌換期間</p>
            <p className="text-[11px] text-[#6b1111] font-bold">2026/02/23 － 03/23</p>
          </div>
        </section>

        {showAdmin && (
          <div className="mt-8 p-4 border-2 border-dashed border-red-200 bg-red-50 text-center rounded-lg">
            <button 
              onClick={() => { setMyTicket(null); setClaimedCount(0); setShowAdmin(false); }}
              className="px-6 py-2 bg-red-500 text-white text-[10px] font-bold rounded-sm shadow-md"
            >
              本地重置 (Demo 用)
            </button>
          </div>
        )}

        <footer className="text-center pt-16 pb-6">
          <button 
            onClick={() => { setClickCount(c => c + 1); if (clickCount >= 4) { setShowAdmin(!showAdmin); setClickCount(0); } }}
            className="text-[9px] tracking-[0.8em] uppercase text-slate-300 hover:text-[#c9a063] transition-all"
          >
            蕎淶清飲 ． Chillax Drink
          </button>
        </footer>
      </main>
    </div>
  );
};

export default App;

